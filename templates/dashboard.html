{% extends "base.html" %}

{% block title %}Dashboard - Chatlytics{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-700 dark:from-blue-700 dark:via-purple-700 dark:to-indigo-800 shadow-xl">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="text-center md:text-left">
                <h1 class="text-3xl font-bold text-white mb-2 flex items-center justify-center md:justify-start">
                    <i data-lucide="message-square" class="w-7 h-7 mr-2"></i>
                    Chat Analytics
                    <i data-lucide="bar-chart-3" class="w-5 h-5 ml-3"></i>
                </h1>
                <p class="text-blue-100 text-lg" id="filename-display">{{ filename }}</p>
            </div>
            <div class="flex items-center space-x-3 flex-wrap justify-center">
                <button id="help-button" 
                        class="bg-white/20 backdrop-blur-sm text-white px-4 py-3 rounded-xl hover:bg-white/30 transition-all duration-300 flex items-center space-x-2 border border-white/30"
                        onclick="toggleHelp()">
                    <i data-lucide="help-circle" class="w-5 h-5"></i>
                    <span class="font-medium hidden sm:block">Guide</span>
                </button>
                <button id="export-pdf" 
                        class="bg-white/20 backdrop-blur-sm text-white px-4 py-3 rounded-xl hover:bg-white/30 transition-all duration-300 flex items-center space-x-2 border border-white/30">
                    <i data-lucide="download" class="w-5 h-5"></i>
                    <span class="font-medium hidden sm:block">Export PDF</span>
                </button>
                <a href="/" 
                   class="bg-white text-blue-600 dark:text-blue-700 px-4 py-3 rounded-xl hover:bg-blue-50 dark:hover:bg-gray-100 transition-all duration-300 flex items-center space-x-2 font-medium">
                    <i data-lucide="upload" class="w-5 h-5"></i>
                    <span class="hidden sm:block">New Upload</span>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Loading State -->
<div id="loading-state" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
    <div class="text-center bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-12 border border-gray-100 dark:border-gray-700 soft-glow">
        <div class="loading-spinner mx-auto mb-8"></div>
        <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-3"><i data-lucide="search" class="w-6 h-6 inline-block mr-2 align-text-bottom"></i> Analyzing your chat data...</h3>
        <p class="text-gray-600 dark:text-gray-400 mb-8 text-lg">This may take a moment for large conversations</p>
        
        <!-- Progress Steps -->
        <div class="max-w-lg mx-auto">
            <div class="flex items-center justify-between mb-6">
                <div class="flex flex-col items-center">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center shadow-lg">
                        <i data-lucide="message-square" class="w-6 h-6 text-white" id="step-1-icon"></i>
                    </div>
                    <span class="mt-2 text-sm font-medium text-gray-700 dark:text-gray-300" id="step-1-text">Parsing messages</span>
                </div>
                <div class="flex flex-col items-center">
                    <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-full flex items-center justify-center shadow-lg" id="step-2-icon">
                        <i data-lucide="bar-chart-3" class="w-6 h-6 text-white"></i>
                    </div>
                    <span class="mt-2 text-sm font-medium text-gray-700 dark:text-gray-300" id="step-2-text">Generating analytics</span>
                </div>
                <div class="flex flex-col items-center">
                    <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-full flex items-center justify-center shadow-lg" id="step-3-icon">
                        <i data-lucide="brain" class="w-6 h-6 text-white"></i>
                    </div>
                    <span class="mt-2 text-sm font-medium text-gray-700 dark:text-gray-300" id="step-3-text">AI insights</span>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="w-full bg-gray-200 rounded-full h-3 shadow-inner overflow-hidden">
                <div class="bg-gradient-to-r from-blue-500 via-purple-500 to-green-500 h-3 rounded-full transition-all duration-700 shadow-sm w-0" id="progress-bar"></div>
            </div>
        </div>
    </div>
</div>

<!-- Dashboard Content -->
<div id="dashboard-content" class="hidden">
    <!-- Navigation Tabs -->
    <div class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-100 dark:border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <nav class="flex space-x-1 overflow-x-auto scrollbar-hide">
                <button class="tab-button active py-4 px-4 md:px-6 border-b-3 border-blue-500 text-blue-600 dark:text-blue-400 font-semibold bg-blue-50/50 dark:bg-blue-900/20 rounded-t-lg transition-all duration-300 flex items-center whitespace-nowrap" 
                        data-tab="overview">
                    <i data-lucide="layout-dashboard" class="w-4 h-4 mr-1 md:mr-2"></i> <span class="hidden sm:inline">Overview</span>
                </button>
                <button class="tab-button py-4 px-4 md:px-6 border-b-3 border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 font-medium rounded-t-lg transition-all duration-300 flex items-center whitespace-nowrap" 
                        data-tab="messages">
                    <i data-lucide="message-square" class="w-4 h-4 mr-1 md:mr-2"></i> <span class="hidden sm:inline">Messages</span>
                </button>
                <button class="tab-button py-4 px-4 md:px-6 border-b-3 border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 font-medium rounded-t-lg transition-all duration-300 flex items-center whitespace-nowrap" 
                        data-tab="emojis">
                    <i data-lucide="smile" class="w-4 h-4 mr-1 md:mr-2"></i> <span class="hidden sm:inline">Emojis</span>
                </button>
                <button class="tab-button py-4 px-4 md:px-6 border-b-3 border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 font-medium rounded-t-lg transition-all duration-300 flex items-center whitespace-nowrap" 
                        data-tab="timing">
                    <i data-lucide="clock" class="w-4 h-4 mr-1 md:mr-2"></i> <span class="hidden sm:inline">Timing</span>
                </button>
                <button class="tab-button py-4 px-4 md:px-6 border-b-3 border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 font-medium rounded-t-lg transition-all duration-300 flex items-center whitespace-nowrap" 
                        data-tab="sentiment">
                    <i data-lucide="activity" class="w-4 h-4 mr-1 md:mr-2"></i> <span class="hidden sm:inline">Sentiment</span>
                </button>
                <button class="tab-button py-4 px-4 md:px-6 border-b-3 border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 font-medium rounded-t-lg transition-all duration-300 flex items-center whitespace-nowrap" 
                        data-tab="ai-insights">
                    <i data-lucide="bot" class="w-4 h-4 mr-1 md:mr-2"></i> <span class="hidden sm:inline">AI Insights</span>
                </button>
                <button class="tab-button py-4 px-4 md:px-6 border-b-3 border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 font-medium rounded-t-lg transition-all duration-300 flex items-center whitespace-nowrap" 
                        data-tab="who-thinks-first">
                    <i data-lucide="alarm-clock" class="w-4 h-4 mr-1 md:mr-2"></i> <span class="hidden md:inline">First Message</span><span class="hidden sm:inline md:hidden">First</span>
                </button>
                <button class="tab-button py-4 px-4 md:px-6 border-b-3 border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 font-medium rounded-t-lg transition-all duration-300 flex items-center whitespace-nowrap" 
                        data-tab="advanced">
                    <i data-lucide="rocket" class="w-4 h-4 mr-1 md:mr-2"></i> <span class="hidden sm:inline">Advanced</span>
                </button>
            </nav>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Overview Tab -->
        <div id="overview-tab" class="tab-content">
            <!-- Welcome Section -->
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/30 dark:to-purple-900/30 rounded-2xl p-6 mb-8 border border-blue-200/50 dark:border-blue-700/50">
                <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-2"><i data-lucide="party-popper" class="w-5 h-5 inline-block mr-2 align-text-bottom"></i> Welcome to Your Chat Analytics!</h2>
                <p class="text-gray-600 dark:text-gray-400">Here's everything we discovered about your conversation. Scroll through the tabs to explore different aspects of your communication patterns.</p>
            </div>
            
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 dark:from-blue-900/30 dark:to-blue-800/40 rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 card-hover bounce-in border border-blue-200/50 dark:border-blue-700/50">
                    <div class="flex items-center">
                        <div class="w-14 h-14 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg">
                            <i data-lucide="message-circle" class="w-7 h-7 text-white"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-300 flex items-center">
                                Total Messages
                                <i data-lucide="info" class="ml-1 w-4 h-4 text-gray-400 dark:text-gray-500 cursor-help" title="The total number of messages exchanged in your conversation"></i>
                            </p>
                            <p class="text-2xl font-bold text-gray-900 dark:text-gray-100" id="total-messages">-</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900/30 dark:to-green-800/40 rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all duration-300 card-hover bounce-in border border-green-200/50 dark:border-green-700/50 anim-delay-100">
                    <div class="flex items-center">
                        <div class="w-14 h-14 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center shadow-lg">
                            <i data-lucide="users" class="w-7 h-7 text-white"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-300 flex items-center">
                                Participants
                                <i data-lucide="info" class="ml-1 w-4 h-4 text-gray-400 dark:text-gray-500 cursor-help" title="Number of people in this conversation"></i>
                            </p>
                            <p class="text-2xl font-bold text-gray-900 dark:text-gray-100" id="participants-count">-</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-700 rounded-xl p-6 shadow-sm card-hover bounce-in anim-delay-200 border border-gray-100 dark:border-gray-600">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-purple-100 dark:bg-purple-800 rounded-lg flex items-center justify-center">
                            <i data-lucide="calendar" class="w-6 h-6 text-purple-600 dark:text-purple-300"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-300">Duration</p>
                            <p class="text-2xl font-bold text-gray-900 dark:text-white" id="conversation-duration">-</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-700 rounded-xl p-6 shadow-sm card-hover bounce-in anim-delay-300 border border-gray-100 dark:border-gray-600">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-yellow-100 dark:bg-yellow-800 rounded-lg flex items-center justify-center">
                            <i data-lucide="heart" class="w-6 h-6 text-yellow-600 dark:text-yellow-300"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-600 dark:text-gray-300">Avg Affinity</p>
                            <p class="text-2xl font-bold text-gray-900 dark:text-white" id="avg-affinity">-</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Fun Metrics -->
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm mb-8 border border-gray-100 dark:border-gray-700">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-6">Fun Achievements</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="fun-metrics">
                    <!-- Fun metrics will be populated here -->
                </div>
            </div>
            
            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm ring-1 ring-gray-100 dark:ring-gray-700 border dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Message Distribution</h3>
                    <div id="message-distribution-chart" class="h-[400px]"></div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm ring-1 ring-gray-100 dark:ring-gray-700 border dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Activity Timeline</h3>
                    <div id="activity-timeline-chart" class="h-[400px]"></div>
                </div>
            </div>
        </div>
        
        <!-- Messages Tab -->
        <div id="messages-tab" class="tab-content hidden">
            <!-- Explanation -->
            <div class="bg-blue-50 dark:bg-blue-900/30 rounded-xl p-4 mb-6 border border-blue-200 dark:border-blue-700">
                <h3 class="font-semibold text-blue-900 dark:text-blue-200 mb-2"><i data-lucide="file-text" class="w-4 h-4 inline-block mr-2 align-text-bottom"></i> About Message Analysis</h3>
                <p class="text-blue-700 dark:text-blue-300 text-sm">This section shows who writes more and how you both express yourselves. Word count can reveal communication styles - some people are naturally more verbose!</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm ring-1 ring-gray-100 dark:ring-gray-700 border dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Word Count Comparison</h3>
                    <div id="word-count-chart" class="h-[400px]"></div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm ring-1 ring-gray-100 dark:ring-gray-700 border dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Message Length Distribution</h3>
                    <div id="message-length-chart" class="h-[400px]"></div>
                </div>
            </div>
            
            <div class="mt-8 bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm border dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Common Words</h3>
                <div id="common-words-content">
                    <!-- Common words will be populated here -->
                </div>
            </div>
        </div>
        
        <!-- Emojis Tab -->
        <div id="emojis-tab" class="tab-content hidden">
            <!-- Explanation -->
            <div class="bg-yellow-50 dark:bg-yellow-900/30 rounded-xl p-4 mb-6 border border-yellow-200 dark:border-yellow-700">
                <h3 class="font-semibold text-yellow-900 dark:text-yellow-200 mb-2"><i data-lucide="smile" class="w-4 h-4 inline-block mr-2 align-text-bottom"></i> About Emoji Analysis</h3>
                <p class="text-yellow-700 dark:text-yellow-300 text-sm">Emojis reveal personality! See which ones you use most and discover your unique emoji signature. Are you the üòÇ type or more of a ‚ù§Ô∏è person?</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm ring-1 ring-gray-100 dark:ring-gray-700 border dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Top Emojis</h3>
                    <div id="emoji-usage-chart" class="h-[400px]"></div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm ring-1 ring-gray-100 dark:ring-gray-700 border dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Emoji Usage by Participant</h3>
                    <div id="emoji-participant-content">
                        <!-- Emoji stats by participant will be populated here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Timing Tab -->
        <div id="timing-tab" class="tab-content hidden">
            <!-- Explanation -->
            <div class="bg-purple-50 dark:bg-purple-900/30 rounded-xl p-4 mb-6 border border-purple-200 dark:border-purple-700">
                <h3 class="font-semibold text-purple-900 dark:text-purple-200 mb-2"><i data-lucide="clock" class="w-4 h-4 inline-block mr-2 align-text-bottom"></i> About Timing Analysis</h3>
                <p class="text-purple-700 dark:text-purple-300 text-sm">When do you chat the most? This reveals your daily rhythms and shows if you're night owls, early birds, or weekend warriors!</p>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm ring-1 ring-gray-100 dark:ring-gray-700 border dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Activity by Hour</h3>
                    <div id="hourly-heatmap-chart" class="h-[400px]"></div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm ring-1 ring-gray-100 dark:ring-gray-700 border dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Activity by Day</h3>
                    <div id="daily-activity-chart" class="h-[400px]"></div>
                </div>
            </div>
            
            <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm ring-1 ring-gray-100 dark:ring-gray-700 border dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Response Times</h3>
                    <div id="response-times-chart" class="h-[400px]"></div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm ring-1 ring-gray-100 dark:ring-gray-700 border dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Timing Insights</h3>
                    <div id="timing-insights-content">
                        <!-- Timing insights will be populated here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sentiment Analysis Tab -->
        <div id="sentiment-tab" class="tab-content hidden">
            <div class="space-y-8">
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm ring-1 ring-gray-100 dark:ring-gray-700 border dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Sentiment Overview</h3>
                    <div id="sentiment-overview" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Sentiment data will be populated here -->
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm ring-1 ring-gray-100 dark:ring-gray-700 border dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Message Length Analysis</h3>
                        <div id="message-length-analysis">
                            <!-- Message length analysis will be populated here -->
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm ring-1 ring-gray-100 dark:ring-gray-700 border dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Conversation Flow</h3>
                        <div id="conversation-flow-analysis">
                            <!-- Conversation flow analysis will be populated here -->
                        </div>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm ring-1 ring-gray-100 dark:ring-gray-700 border dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Activity Patterns</h3>
                    <div id="activity-patterns-analysis">
                        <!-- Activity patterns will be populated here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- AI Insights Tab -->
        <div id="ai-insights-tab" class="tab-content hidden">
            <div class="space-y-8">
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm ring-1 ring-gray-100 dark:ring-gray-700 border dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Overall Summary</h3>
                    <div id="ai-overall-summary" class="prose prose-gray max-w-none">
                        <!-- AI summary will be populated here -->
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm ring-1 ring-gray-100 dark:ring-gray-700 border dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Personality Analysis</h3>
                        <div id="ai-personality" class="prose prose-gray dark:prose-invert max-w-none">
                            <!-- Personality analysis will be populated here -->
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm ring-1 ring-gray-100 dark:ring-gray-700 border dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Relationship Dynamics</h3>
                        <div id="ai-relationship" class="prose prose-gray dark:prose-invert max-w-none">
                            <!-- Relationship dynamics will be populated here -->
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm ring-1 ring-gray-100 dark:ring-gray-700 border dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Conversation Style</h3>
                        <div id="ai-conversation-style" class="prose prose-gray dark:prose-invert max-w-none">
                            <!-- Conversation style will be populated here -->
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm ring-1 ring-gray-100 dark:ring-gray-700 border dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Fun Facts</h3>
                        <div id="ai-fun-facts" class="prose prose-gray dark:prose-invert max-w-none">
                            <!-- Fun facts will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Who Thinks First Tab -->
        <div id="who-thinks-first-tab" class="tab-content hidden">
            <div class="space-y-8">
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm ring-1 ring-gray-100 dark:ring-gray-700 border dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Who Thinks About Who First</h3>
                    <div id="who-thinks-first-insights" class="prose prose-gray dark:prose-invert max-w-none mb-6">
                        <!-- Insights will be populated here -->
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm ring-1 ring-gray-100 dark:ring-gray-700 border dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Daily Calendar</h3>
                        <div id="who-thinks-first-calendar-chart" class="h-[400px]"></div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm ring-1 ring-gray-100 dark:ring-gray-700 border dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Daily Counts</h3>
                        <div id="who-thinks-first-bar-chart" class="h-[400px]"></div>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm ring-1 ring-gray-100 dark:ring-gray-700 border dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Detailed Statistics</h3>
                    <div id="who-thinks-first-stats">
                        <!-- Detailed stats will be populated here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Advanced Tab -->
        <div id="advanced-tab" class="tab-content hidden">
            <div class="space-y-8">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm ring-1 ring-gray-100 dark:ring-gray-700 border dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Love/Affection Score</h3>
                        <div id="affection-score-gauge" class="h-[400px]"></div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm ring-1 ring-gray-100 dark:ring-gray-700 border dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Compatibility Index</h3>
                        <div id="compatibility-meter" class="h-[400px]"></div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm ring-1 ring-gray-100 dark:ring-gray-700 border dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Mood Over Time</h3>
                        <div id="mood-timeline-chart" class="h-[400px]"></div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm ring-1 ring-gray-100 dark:ring-gray-700 border dark:border-gray-700">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Streaks & Gaps</h3>
                        <div id="streaks-gaps-timeline-chart" class="h-[400px]"></div>
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm ring-1 ring-gray-100 dark:ring-gray-700 border dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Word Cloud</h3>
                    <div id="wordcloud-container" class="text-center">
                        <!-- Word cloud will be populated here -->
                    </div>
                </div>
                
                <div class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-sm ring-1 ring-gray-100 dark:ring-gray-700 border dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Personalized AI Report</h3>
                    <div id="personalized-ai-report" class="prose prose-gray max-w-none">
                        <!-- Personalized report will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Error State -->
<div id="error-state" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-700 rounded-lg p-6 text-center">
        <i data-lucide="alert-circle" class="w-12 h-12 text-red-600 dark:text-red-400 mx-auto mb-4"></i>
        <h3 class="text-lg font-semibold text-red-800 dark:text-red-200 mb-2">Analysis Failed</h3>
        <p class="text-red-600 dark:text-red-300 mb-4" id="error-message">There was an error analyzing your chat data.</p>
        <a href="/" class="bg-red-600 dark:bg-red-700 text-white px-4 py-2 rounded-lg hover:bg-red-700 dark:hover:bg-red-600 transition-colors">
            Try Again
        </a>
    </div>
</div>

<!-- Help Modal -->
<div id="help-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto border dark:border-gray-700">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white"><i data-lucide="book-open" class="w-5 h-5 inline-block mr-2 align-text-bottom"></i> Dashboard Guide</h2>
                <button onclick="toggleHelp()" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="space-y-6">
                <div class="bg-blue-50 dark:bg-blue-900/30 rounded-lg p-4 border dark:border-blue-700">
                    <h3 class="font-semibold text-blue-900 dark:text-blue-200 mb-2"><i data-lucide="layout-dashboard" class="w-4 h-4 inline-block mr-2 align-text-bottom"></i> Overview Tab</h3>
                    <p class="text-blue-800 dark:text-blue-300 text-sm">Your conversation at a glance! See total messages, participants, and fun achievements like who's the emoji champion or conversation starter.</p>
                </div>
                
                <div class="bg-green-50 dark:bg-green-900/30 rounded-lg p-4 border dark:border-green-700">
                    <h3 class="font-semibold text-green-900 dark:text-green-200 mb-2"><i data-lucide="message-square" class="w-4 h-4 inline-block mr-2 align-text-bottom"></i> Messages Tab</h3>
                    <p class="text-green-800 dark:text-green-300 text-sm">Discover who writes more and how you express yourselves. Compare word counts and see your most common words!</p>
                </div>
                
                <div class="bg-yellow-50 dark:bg-yellow-900/30 rounded-lg p-4 border dark:border-yellow-700">
                    <h3 class="font-semibold text-yellow-900 dark:text-yellow-200 mb-2"><i data-lucide="smile" class="w-4 h-4 inline-block mr-2 align-text-bottom"></i> Emojis Tab</h3>
                    <p class="text-yellow-800 dark:text-yellow-300 text-sm">Your emoji personality revealed! See which emojis you use most and discover your unique emoji signature.</p>
                </div>
                
                <div class="bg-purple-50 dark:bg-purple-900/30 rounded-lg p-4 border dark:border-purple-700">
                    <h3 class="font-semibold text-purple-900 dark:text-purple-200 mb-2"><i data-lucide="clock" class="w-4 h-4 inline-block mr-2 align-text-bottom"></i> Timing Tab</h3>
                    <p class="text-purple-800 dark:text-purple-300 text-sm">When do you chat the most? Discover if you're night owls, early birds, or weekend warriors based on your activity patterns.</p>
                </div>
                
                <div class="bg-pink-50 dark:bg-pink-900/30 rounded-lg p-4 border dark:border-pink-700">
                    <h3 class="font-semibold text-pink-900 dark:text-pink-200 mb-2"><i data-lucide="activity" class="w-4 h-4 inline-block mr-2 align-text-bottom"></i> Sentiment Tab</h3>
                    <p class="text-pink-800 dark:text-pink-300 text-sm">How positive are your conversations? See the emotional tone of your messages and conversation flow patterns.</p>
                </div>
                
                <div class="bg-indigo-50 dark:bg-indigo-900/30 rounded-lg p-4 border dark:border-indigo-700">
                    <h3 class="font-semibold text-indigo-900 dark:text-indigo-200 mb-2"><i data-lucide="bot" class="w-4 h-4 inline-block mr-2 align-text-bottom"></i> AI Insights Tab</h3>
                    <p class="text-indigo-800 dark:text-indigo-300 text-sm">AI-powered personality analysis! Get insights about communication styles, relationship dynamics, and fun facts about your bond.</p>
                </div>
                
                <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 border dark:border-gray-600">
                    <h3 class="font-semibold text-gray-900 dark:text-gray-200 mb-2"><i data-lucide="bar-chart-3" class="w-4 h-4 inline-block mr-2 align-text-bottom"></i> Understanding the Charts</h3>
                    <ul class="text-gray-700 dark:text-gray-300 text-sm space-y-1">
                        <li>‚Ä¢ <strong>Hover</strong> over charts to see detailed information</li>
                        <li>‚Ä¢ <strong>Click and drag</strong> to zoom into specific time periods</li>
                        <li>‚Ä¢ <strong>Double-click</strong> to reset zoom</li>
                        <li>‚Ä¢ Charts are interactive - explore them!</li>
                    </ul>
                </div>
                
                <div class="bg-green-50 dark:bg-green-900/30 rounded-lg p-4 border dark:border-green-700">
                    <h3 class="font-semibold text-green-900 dark:text-green-200 mb-2"><i data-lucide="lock" class="w-4 h-4 inline-block mr-2 align-text-bottom"></i> Privacy & Security</h3>
                    <p class="text-green-800 dark:text-green-300 text-sm">Your data is processed locally and never stored permanently. We respect your privacy and keep your conversations secure.</p>
                </div>
            </div>
            
            <div class="mt-6 text-center">
                <button onclick="toggleHelp()" class="bg-blue-600 dark:bg-blue-700 text-white px-6 py-3 rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 transition-colors font-medium">
                    <i data-lucide="rocket" class="w-4 h-4 inline-block mr-2 align-text-bottom"></i> Got it!
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const sessionId = '{{ session_id }}';
    const loadingState = document.getElementById('loading-state');
    const dashboardContent = document.getElementById('dashboard-content');
    const errorState = document.getElementById('error-state');
    const errorMessage = document.getElementById('error-message');
    
    let analyticsData = null;
    let aiInsights = null;
    let chartsData = null;
    
    // Global Plotly configuration
    const plotlyConfig = {
        responsive: true,
        displayModeBar: true,
        displaylogo: false
    };
    
    // Initialize dashboard
    initializeDashboard();
    
    async function initializeDashboard() {
        try {
            console.log('Starting dashboard initialization...');
            
            // Start progress animation immediately
            updateProgress(5, 'step-1');
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Load analytics first
            console.log('Loading analytics...');
            updateProgress(25, 'step-1');
            
            const analyticsResponse = await fetch(`/api/analytics/${sessionId}`);
            if (!analyticsResponse.ok) {
                const errorText = await analyticsResponse.text();
                throw new Error(`Analytics request failed: ${analyticsResponse.status} - ${errorText}`);
            }
            analyticsData = await analyticsResponse.json();
            console.log('Analytics loaded successfully:', Object.keys(analyticsData));
            
            updateProgress(50, 'step-2');
            await new Promise(resolve => setTimeout(resolve, 300));
            
            // Load charts
            console.log('Loading charts...');
            const chartsResponse = await fetch(`/api/charts/${sessionId}`);
            if (!chartsResponse.ok) {
                const errorText = await chartsResponse.text();
                throw new Error(`Charts request failed: ${chartsResponse.status} - ${errorText}`);
            }
            chartsData = await chartsResponse.json();
            console.log('Charts loaded successfully:', Object.keys(chartsData));
            
            updateProgress(75, 'step-2');
            await new Promise(resolve => setTimeout(resolve, 300));
            
            // Load AI insights
            console.log('Loading AI insights...');
            const aiResponse = await fetch(`/api/ai-insights/${sessionId}`);
            if (!aiResponse.ok) {
                const errorText = await aiResponse.text();
                throw new Error(`AI insights request failed: ${aiResponse.status} - ${errorText}`);
            }
            aiInsights = await aiResponse.json();
            console.log('AI insights loaded successfully:', Object.keys(aiInsights));
            
            updateProgress(90, 'step-3');
            await new Promise(resolve => setTimeout(resolve, 300));
            
            // Populate dashboard sections safely
            console.log('Populating dashboard sections...');
            try {
                if (analyticsData && chartsData) {
                    populateOverview();
                    populateMessages();
                    populateEmojis();
                    populateTiming();
                    populateSentiment();
                }
                
                if (aiInsights) {
                    populateAIInsights();
                }
                
                if (analyticsData && chartsData) {
                    populateWhoThinksFirst();
                    populateAdvanced();
                }
            } catch (populateError) {
                console.error('Error populating sections:', populateError);
                // Continue anyway to show whatever data we can
            }
            
            updateProgress(100, 'step-3');
            console.log('Dashboard fully loaded!');
            
            // Show dashboard after a short delay
            setTimeout(() => {
                if (loadingState) loadingState.classList.add('hidden');
                if (dashboardContent) {
                    dashboardContent.classList.remove('hidden');
                    dashboardContent.classList.add('fade-in');
                }
            }, 800);
            
        } catch (error) {
            console.error('Dashboard initialization error:', error);
            showError(`Failed to load dashboard data: ${error.message}`);
        }
    }
    
    function showError(message) {
        const loadingState = document.getElementById('loading-state');
        const errorState = document.getElementById('error-state');
        const errorMessage = document.getElementById('error-message');
        
        if (loadingState) loadingState.classList.add('hidden');
        if (errorState) errorState.classList.remove('hidden');
        if (errorMessage) errorMessage.textContent = message;
    }
    
    function updateProgress(percentage, step) {
        console.log(`Updating progress: ${percentage}% - Step: ${step}`);
        
        const progressBar = document.getElementById('progress-bar');
        if (progressBar) {
            progressBar.style.width = percentage + '%';
            console.log(`Progress bar updated to ${percentage}%`);
        } else {
            console.error('Progress bar element not found');
        }
        
        // Update step indicators more safely
        if (step && percentage >= 25) {
            const stepElement = document.querySelector(`#${step}-icon`);
            const stepText = document.querySelector(`#${step}-text`);
            
            if (stepElement && stepElement.parentElement) {
                stepElement.parentElement.className = stepElement.parentElement.className.replace(/from-\w+-500 to-\w+-600/, 'from-green-500 to-green-600');
                stepElement.innerHTML = '<i data-lucide="check" class="w-6 h-6 text-white"></i>';
            }
            
            if (stepText) {
                stepText.className = 'mt-2 text-sm font-medium text-green-600 dark:text-green-400';
            }
        }
        
        // Re-initialize icons safely
        if (window.lucide && typeof lucide.createIcons === 'function') {
            setTimeout(() => {
                try {
                    lucide.createIcons();
                } catch (e) {
                    console.warn('Lucide icons initialization error:', e);
                }
            }, 100);
        }
    }
    
    function populateOverview() {
        console.log('Populating overview...', analyticsData ? 'Analytics data available' : 'No analytics data');
        if (!analyticsData || !analyticsData.basic_stats) {
            console.error('Analytics data not available:', analyticsData);
            return;
        }
        console.log('Basic stats:', analyticsData.basic_stats);
        
        const basicStats = analyticsData.basic_stats;
        
        // Update stats cards safely
        const totalMessagesEl = document.getElementById('total-messages');
        console.log('Total messages element:', totalMessagesEl, 'Value:', basicStats.total_messages);
        if (totalMessagesEl && basicStats.total_messages) {
            totalMessagesEl.textContent = basicStats.total_messages.toLocaleString();
            console.log('Updated total messages to:', basicStats.total_messages.toLocaleString());
        } else {
            console.warn('Could not update total messages:', {totalMessagesEl, value: basicStats.total_messages});
        }
        
        const participantsEl = document.getElementById('participants-count');
        if (participantsEl && basicStats.senders) {
            participantsEl.textContent = basicStats.senders.length;
        }
        
        const durationEl = document.getElementById('conversation-duration');
        if (durationEl && basicStats.date_range) {
            const days = basicStats.date_range.duration_days || 1;
            durationEl.textContent = `${days} day${days !== 1 ? 's' : ''}`;
        }
        
        // Calculate average affinity safely
        const affinityScores = analyticsData.affinity_scores || {};
        const avgAffinity = Object.values(affinityScores).length > 0 ? 
            Object.values(affinityScores).reduce((a, b) => a + b, 0) / Object.values(affinityScores).length : 0;
        
        const affinityEl = document.getElementById('avg-affinity');
        if (affinityEl) {
            affinityEl.textContent = avgAffinity.toFixed(1);
        }
        
        // Populate fun metrics
        populateFunMetrics();
        
        // Render charts safely
        
        try {
            if (chartsData && chartsData.message_distribution) {
                console.log('Rendering message distribution chart...');
                const chartData = JSON.parse(chartsData.message_distribution);
                if (chartData.data && chartData.layout) {
                    Plotly.newPlot('message-distribution-chart', chartData.data, chartData.layout, plotlyConfig);
                    console.log('Message distribution chart rendered successfully');
                } else {
                    console.warn('Invalid chart data structure for message distribution');
                }
            } else {
                console.warn('No message distribution data available');
            }
        } catch (e) {
            console.error('Failed to render message distribution chart:', e);
        }
        
        try {
            if (chartsData && chartsData.activity_timeline) {
                const chartData = JSON.parse(chartsData.activity_timeline);
                Plotly.newPlot('activity-timeline-chart', chartData.data, chartData.layout, plotlyConfig);
            }
        } catch (e) {
            console.warn('Failed to render activity timeline chart:', e);
        }
    }
    
    function populateFunMetrics() {
        if (!analyticsData) return;
        
        const funMetrics = analyticsData.fun_metrics || {};
        const affinityScores = analyticsData.affinity_scores || {};
        
        const metricsContainer = document.getElementById('fun-metrics');
        if (!metricsContainer) return;
        
        const metrics = [
            { icon: 'crown', title: 'Message Leader', value: funMetrics.message_leader || 'N/A', color: 'bg-yellow-50 dark:bg-yellow-900/30 text-yellow-600 dark:text-yellow-300' },
            { icon: 'type', title: 'Word Leader', value: funMetrics.word_leader || 'N/A', color: 'bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-300' },
            { icon: 'smile', title: 'Emoji Champion', value: funMetrics.emoji_leader || 'N/A', color: 'bg-green-50 dark:bg-green-900/30 text-green-600 dark:text-green-300' },
            { icon: 'zap', title: 'Conversation Starter', value: funMetrics.initiator_leader || 'N/A', color: 'bg-purple-50 dark:bg-purple-900/30 text-purple-600 dark:text-purple-300' },
            { icon: 'moon', title: 'Night Owl', value: funMetrics.night_owl || 'N/A', color: 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-300' }
        ];
        
        let html = '';
        metrics.forEach(metric => {
            html += `
                <div class="${metric.color} rounded-lg p-4 text-center border border-gray-200 dark:border-gray-700">
                    <div class="w-8 h-8 bg-white dark:bg-gray-700 rounded-lg flex items-center justify-center mx-auto mb-2 shadow-sm">
                        <i data-lucide="${metric.icon}" class="w-4 h-4 text-gray-600 dark:text-gray-300"></i>
                    </div>
                    <h4 class="font-semibold text-gray-900 dark:text-gray-100 text-sm">${metric.title}</h4>
                    <p class="font-medium text-gray-800 dark:text-gray-200">${metric.value}</p>
                </div>
            `;
        });
        
        // Add affinity scores safely
        Object.entries(affinityScores || {}).forEach(([sender, score]) => {
            if (typeof score === 'number') {
                html += `
                    <div class="bg-red-50 dark:bg-red-900/30 rounded-lg p-4 text-center border border-gray-200 dark:border-gray-700">
                        <div class="w-8 h-8 bg-white dark:bg-gray-700 rounded-lg flex items-center justify-center mx-auto mb-2 shadow-sm">
                            <i data-lucide="heart" class="w-4 h-4 text-red-600 dark:text-red-400"></i>
                        </div>
                        <h4 class="font-semibold text-gray-900 dark:text-gray-100 text-sm">Affinity - ${sender}</h4>
                        <p class="text-red-600 dark:text-red-400 font-medium">${score.toFixed(1)}/100</p>
                    </div>
                `;
            }
        });
        
        metricsContainer.innerHTML = html;
        
        // Re-initialize icons safely
        if (window.lucide) {
            lucide.createIcons();
        }
    }
    
    // Toggle help modal
    function toggleHelp() {
        const helpModal = document.getElementById('help-modal');
        if (helpModal) {
            helpModal.classList.toggle('hidden');
        }
    }
    
    function populateMessages() {
        if (!chartsData || !analyticsData) {
            console.warn('Missing data for messages tab');
            return;
        }
        
        try {
            // Word count chart
            if (chartsData.word_count) {
                const chartData = JSON.parse(chartsData.word_count);
                Plotly.newPlot('word-count-chart', chartData.data, chartData.layout, plotlyConfig);
            }
        } catch (e) {
            console.warn('Failed to render word count chart:', e);
        }
        
        try {
            // Message length chart
            if (chartsData.message_length) {
                const chartData = JSON.parse(chartsData.message_length);
                Plotly.newPlot('message-length-chart', chartData.data, chartData.layout, plotlyConfig);
            }
        } catch (e) {
            console.warn('Failed to render message length chart:', e);
        }
        
        // Common words
        const commonWords = analyticsData.keyword_tracker?.overall_common_words || {};
        const commonWordsContent = document.getElementById('common-words-content');
        
        if (commonWordsContent) {
            const topWords = Object.entries(commonWords || {}).slice(0, 20);
            commonWordsContent.innerHTML = `
                <div class="flex flex-wrap gap-2">
                    ${topWords.map(([word, count]) => `
                        <span class="bg-blue-100 dark:bg-blue-900/50 text-blue-800 dark:text-blue-200 px-3 py-1 rounded-full text-sm font-medium border dark:border-blue-700">
                            ${word} (${count})
                        </span>
                    `).join('')}
                </div>
            `;
        }
    }
    
    function populateEmojis() {
        // Emoji usage chart
        if (chartsData.emoji_usage) {
            const chartData = JSON.parse(chartsData.emoji_usage);
            Plotly.newPlot('emoji-usage-chart', chartData.data, chartData.layout, plotlyConfig);
        }
        
        // Emoji stats by participant
        const emojiStats = analyticsData.emoji_stats;
        const emojiParticipantContent = document.getElementById('emoji-participant-content');
        
        const participantEmojis = emojiStats?.sender_emoji_details || {};
        emojiParticipantContent.innerHTML = Object.entries(participantEmojis || {}).map(([sender, emojis]) => `
            <div class="mb-4">
                <h4 class="font-semibold text-gray-900 mb-2">${sender}</h4>
                <div class="flex flex-wrap gap-1">
                    ${Object.entries(emojis || {}).slice(0, 10).map(([emoji, count]) => `
                        <span class="text-lg" title="${emoji}: ${count}">${emoji}</span>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }
    
    function populateTiming() {
        // Hourly heatmap
        if (chartsData.hourly_heatmap) {
            const chartData = JSON.parse(chartsData.hourly_heatmap);
            Plotly.newPlot('hourly-heatmap-chart', chartData.data, chartData.layout, plotlyConfig);
        }
        
        // Daily activity
        if (chartsData.daily_activity) {
            const chartData = JSON.parse(chartsData.daily_activity);
            Plotly.newPlot('daily-activity-chart', chartData.data, chartData.layout, plotlyConfig);
        }
        
        // Response times
        if (chartsData.response_times) {
            const chartData = JSON.parse(chartsData.response_times);
            Plotly.newPlot('response-times-chart', chartData.data, chartData.layout, plotlyConfig);
        }
        
        // Timing insights
        const timingStats = analyticsData.time_analysis || {};
        const timingInsightsContent = document.getElementById('timing-insights-content');
        
        const responseTimeStats = analyticsData.response_time_analysis || {};
        
        let responseTimeContent = '';
        if (responseTimeStats.average_response_times) {
            const avgTimes = responseTimeStats.average_response_times;
            const medianTimes = responseTimeStats.median_response_times || {};
            const deliveredStatus = responseTimeStats.delivered_status || {};
            const speedPatterns = responseTimeStats.speed_patterns || {};
            
            responseTimeContent = Object.entries(avgTimes).map(([sender, avgTime]) => `
                <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-lg p-4 mb-3">
                    <h5 class="font-semibold text-gray-900 dark:text-white mb-2">${sender} - Response Times</h5>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="bg-white dark:bg-gray-800 rounded p-2">
                            <span class="text-blue-600 dark:text-blue-400 font-medium">Average:</span>
                            <span class="text-gray-900 dark:text-gray-100">${avgTime.toFixed(1)} min</span>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded p-2">
                            <span class="text-green-600 dark:text-green-400 font-medium">Median:</span>
                            <span class="text-gray-900 dark:text-gray-100">${(medianTimes[sender] || 0).toFixed(1)} min</span>
                        </div>
                        ${deliveredStatus[sender] ? `
                        <div class="bg-white dark:bg-gray-800 rounded p-2">
                            <span class="text-red-600 dark:text-red-400 font-medium">Delivered:</span>
                            <span class="text-gray-900 dark:text-gray-100">${deliveredStatus[sender]} times</span>
                        </div>
                        ` : ''}
                        ${speedPatterns[sender] ? `
                        <div class="bg-white dark:bg-gray-800 rounded p-2">
                            <span class="text-purple-600 dark:text-purple-400 font-medium">Instant:</span>
                            <span class="text-gray-900 dark:text-gray-100">${speedPatterns[sender].instant_percent}%</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        timingInsightsContent.innerHTML = `
            <div class="space-y-4">
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                    <h4 class="font-semibold text-gray-900 dark:text-white mb-2"><i data-lucide="clock" class="w-4 h-4 inline mr-2"></i>Most Active Hour</h4>
                    <p class="text-gray-600 dark:text-gray-300">${timingStats.most_active_hour || 'N/A'}:00</p>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                    <h4 class="font-semibold text-gray-900 dark:text-white mb-2"><i data-lucide="calendar" class="w-4 h-4 inline mr-2"></i>Most Active Day</h4>
                    <p class="text-gray-600 dark:text-gray-300">${timingStats.most_active_day || 'N/A'}</p>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                    <h4 class="font-semibold text-gray-900 dark:text-white mb-2"><i data-lucide="moon" class="w-4 h-4 inline mr-2"></i>Late Night Messages</h4>
                    <p class="text-gray-600 dark:text-gray-300">${timingStats.late_night_messages || 0} messages between 12am-3am</p>
                </div>
                ${responseTimeStats.fastest_responder ? `
                <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4">
                    <h4 class="font-semibold text-green-900 dark:text-green-200 mb-2"><i data-lucide="zap" class="w-4 h-4 inline mr-2"></i>Fastest Responder</h4>
                    <p class="text-green-800 dark:text-green-300">${responseTimeStats.fastest_responder}</p>
                </div>
                ` : ''}
                ${responseTimeStats.slowest_responder ? `
                <div class="bg-orange-50 dark:bg-orange-900/20 rounded-lg p-4">
                    <h4 class="font-semibold text-orange-900 dark:text-orange-200 mb-2"><i data-lucide="clock" class="w-4 h-4 inline mr-2"></i>Takes More Time</h4>
                    <p class="text-orange-800 dark:text-orange-300">${responseTimeStats.slowest_responder}</p>
                </div>
                ` : ''}
                ${responseTimeStats.most_delivered ? `
                <div class="bg-red-50 dark:bg-red-900/20 rounded-lg p-4">
                    <h4 class="font-semibold text-red-900 dark:text-red-200 mb-2"><i data-lucide="mail" class="w-4 h-4 inline mr-2"></i>More on Delivered</h4>
                    <p class="text-red-800 dark:text-red-300">${responseTimeStats.most_delivered}</p>
                </div>
                ` : ''}
                ${responseTimeContent ? `
                <div class="mt-4">
                    <h4 class="font-semibold text-gray-900 dark:text-white mb-3"><i data-lucide="trending-up" class="w-4 h-4 inline mr-2"></i>Detailed Response Analysis</h4>
                    ${responseTimeContent}
                </div>
                ` : ''}
                ${responseTimeStats.insight ? `
                <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
                    <h4 class="font-semibold text-blue-900 dark:text-blue-200 mb-2"><i data-lucide="lightbulb" class="w-4 h-4 inline mr-2"></i>Response Insight</h4>
                    <p class="text-blue-800 dark:text-blue-300 text-sm">${responseTimeStats.insight}</p>
                </div>
                ` : ''}
            </div>
        `;
    }
    
    function populateSentiment() {
        // Sentiment analysis
        const sentimentData = analyticsData.sentiment_analysis;
        const sentimentOverview = document.getElementById('sentiment-overview');
        
        if (sentimentData && Object.keys(sentimentData).length > 0) {
            // Filter out non-sender keys like 'sentiment_percentages' and 'overall_mood'
            const senderData = Object.entries(sentimentData).filter(([key, value]) => 
                typeof value === 'object' && value !== null && 'positive' in value
            );
            
            if (senderData.length > 0) {
                sentimentOverview.innerHTML = senderData.map(([sender, sentiments]) => `
                    <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-lg p-4">
                        <h4 class="font-semibold text-gray-900 dark:text-white mb-2">${sender} <i data-lucide="smile" class="inline w-4 h-4 text-green-600 align-text-bottom"></i></h4>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-green-600 dark:text-green-400"><i data-lucide="smile" class="inline w-4 h-4 mr-1 align-text-bottom"></i> Positive</span>
                            <span class="font-medium text-gray-900 dark:text-gray-100">${(sentiments.positive || 0).toFixed(1)}%</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400"><i data-lucide="circle" class="inline w-3 h-3 mr-1 align-text-bottom"></i> Neutral</span>
                            <span class="font-medium text-gray-900 dark:text-gray-100">${(sentiments.neutral || 0).toFixed(1)}%</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-red-600 dark:text-red-400"><i data-lucide="frown" class="inline w-4 h-4 mr-1 align-text-bottom"></i> Negative</span>
                            <span class="font-medium text-gray-900 dark:text-gray-100">${(sentiments.negative || 0).toFixed(1)}%</span>
                        </div>
                    </div>
                </div>
            `).join('');
            } else {
                sentimentOverview.innerHTML = `
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6 text-center">
                        <p class="text-gray-600 dark:text-gray-300"><i data-lucide="info" class="inline w-4 h-4 mr-1 align-text-bottom"></i> No sentiment data available yet. The analysis is still processing!</p>
                    </div>
                `;
            }
        } else {
            sentimentOverview.innerHTML = `
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6 text-center">
                    <p class="text-gray-600 dark:text-gray-300"><i data-lucide="loader" class="inline w-4 h-4 mr-1 align-text-bottom"></i> Loading sentiment analysis...</p>
                </div>
            `;
        }
        
        // Message length analysis
        const messageLengthData = analyticsData.message_length_stats;
        const messageLengthAnalysis = document.getElementById('message-length-analysis');
        
        if (messageLengthData) {
            messageLengthAnalysis.innerHTML = Object.entries(messageLengthData || {}).map(([sender, stats]) => `
                <div class="mb-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <h5 class="font-semibold text-gray-900 dark:text-white mb-2">${sender}</h5>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div class="text-gray-600 dark:text-gray-300">Avg Length: <span class="font-medium text-gray-900 dark:text-gray-100">${(stats.avg_length || 0).toFixed(1)} words</span></div>
                        <div class="text-gray-600 dark:text-gray-300">Max Length: <span class="font-medium text-gray-900 dark:text-gray-100">${stats.max_length} words</span></div>
                        <div class="text-gray-600 dark:text-gray-300">Min Length: <span class="font-medium text-gray-900 dark:text-gray-100">${stats.min_length} words</span></div>
                        <div class="text-gray-600 dark:text-gray-300">Median: <span class="font-medium text-gray-900 dark:text-gray-100">${stats.median_length} words</span></div>
                    </div>
                </div>
            `).join('');
        }
        
        // Conversation flow analysis
        const conversationFlowData = analyticsData.conversation_flow;
        const conversationFlowAnalysis = document.getElementById('conversation-flow-analysis');
        
        if (conversationFlowData && conversationFlowData.turn_stats) {
            conversationFlowAnalysis.innerHTML = Object.entries(conversationFlowData.turn_stats || {}).map(([sender, stats]) => `
                <div class="mb-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <h5 class="font-semibold text-gray-900 dark:text-white mb-2">${sender}</h5>
                    <div class="space-y-1 text-sm">
                        <div class="text-gray-600 dark:text-gray-300">Total Turns: <span class="font-medium text-gray-900 dark:text-gray-100">${stats.total_turns}</span></div>
                        <div class="text-gray-600 dark:text-gray-300">Avg Turn Length: <span class="font-medium text-gray-900 dark:text-gray-100">${(stats.avg_turn_length || 0).toFixed(1)} messages</span></div>
                        <div class="text-gray-600 dark:text-gray-300">Longest Turn: <span class="font-medium text-gray-900 dark:text-gray-100">${stats.max_turn_length} messages</span></div>
                    </div>
                </div>
            `).join('');
        }
        
        // Activity patterns
        const activityPatternsData = analyticsData.activity_patterns;
        const activityPatternsAnalysis = document.getElementById('activity-patterns-analysis');
        
        if (activityPatternsData) {
            activityPatternsAnalysis.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 text-center">
                        <h5 class="font-semibold text-gray-900 dark:text-white mb-1">Most Active Week</h5>
                        <p class="text-blue-600 dark:text-blue-400">${activityPatternsData.most_active_week || 'N/A'}</p>
                    </div>
                    <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4 text-center">
                        <h5 class="font-semibold text-gray-900 dark:text-white mb-1">Most Active Month</h5>
                        <p class="text-green-600 dark:text-green-400">${activityPatternsData.most_active_month || 'N/A'}</p>
                    </div>
                    <div class="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-4 text-center">
                        <h5 class="font-semibold text-gray-900 dark:text-white mb-1">Avg/Week</h5>
                        <p class="text-purple-600 dark:text-purple-400">${(activityPatternsData.avg_messages_per_week || 0).toFixed(1)}</p>
                    </div>
                    <div class="bg-orange-50 dark:bg-orange-900/20 rounded-lg p-4 text-center">
                        <h5 class="font-semibold text-gray-900 dark:text-white mb-1">Avg/Month</h5>
                        <p class="text-orange-600 dark:text-orange-400">${(activityPatternsData.avg_messages_per_month || 0).toFixed(1)}</p>
                    </div>
                </div>
            `;
        }
        lucide.createIcons();
    }

    // Function to format markdown-style text to HTML
    function formatMarkdownToHtml(text) {
        if (!text) return '';
        
        return text
            // Convert **bold text** to <strong>
            .replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold text-gray-900 dark:text-gray-100">$1</strong>')
            // Convert *italic text* to <em>
            .replace(/\*(.*?)\*/g, '<em class="italic text-gray-800 dark:text-gray-200">$1</em>')
            // Convert line breaks to <br>
            .replace(/\n/g, '<br>')
            // Convert numbered lists
            .replace(/^(\d+\.)\s/gm, '<br><span class="font-medium text-blue-600 dark:text-blue-400">$1</span> ')
            // Convert bullet points
            .replace(/^[‚Ä¢¬∑*-]\s/gm, '<br><span class="text-blue-500 dark:text-blue-400">‚Ä¢</span> ');
    }
    
    function populateAIInsights() {
        if (aiInsights.error) {
            document.getElementById('ai-overall-summary').innerHTML = 
                '<div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4"><p class="text-yellow-800 dark:text-yellow-200"><i data-lucide="info" class="inline w-4 h-4 mr-2"></i>AI insights are temporarily unavailable. Using fallback analysis.</p></div>';
            return;
        }
        
        // Overall summary with proper formatting
        if (aiInsights.overall_summary) {
            document.getElementById('ai-overall-summary').innerHTML = 
                `<div class="text-gray-700 dark:text-gray-300 leading-relaxed">${formatMarkdownToHtml(aiInsights.overall_summary)}</div>`;
        }
        
        // Personality analysis with enhanced styling
        if (aiInsights.personality_analysis) {
            document.getElementById('ai-personality').innerHTML = 
                `<div class="text-gray-700 dark:text-gray-300 leading-relaxed">${formatMarkdownToHtml(aiInsights.personality_analysis)}</div>`;
        }
        
        // Relationship dynamics with proper formatting
        if (aiInsights.relationship_dynamics) {
            document.getElementById('ai-relationship').innerHTML = 
                `<div class="text-gray-700 dark:text-gray-300 leading-relaxed">${formatMarkdownToHtml(aiInsights.relationship_dynamics)}</div>`;
        }
        
        // Conversation style with enhanced styling
        if (aiInsights.conversation_style) {
            document.getElementById('ai-conversation-style').innerHTML = 
                `<div class="text-gray-700 dark:text-gray-300 leading-relaxed">${formatMarkdownToHtml(aiInsights.conversation_style)}</div>`;
        }
        
        // Fun facts with better formatting
        if (aiInsights.fun_facts) {
            document.getElementById('ai-fun-facts').innerHTML = 
                `<div class="text-gray-700 dark:text-gray-300 leading-relaxed">${formatMarkdownToHtml(aiInsights.fun_facts)}</div>`;
        }
        
        // Recreate icons after innerHTML changes
        if (window.lucide) {
            lucide.createIcons();
        }
    }
    
    function populateWhoThinksFirst() {
        // Who thinks first calendar chart
        if (chartsData.who_thinks_first_calendar) {
            Plotly.newPlot('who-thinks-first-calendar-chart', JSON.parse(chartsData.who_thinks_first_calendar).data, 
                          JSON.parse(chartsData.who_thinks_first_calendar).layout, {responsive: true});
        }
        
        // Who thinks first bar chart
        if (chartsData.who_thinks_first_bar) {
            Plotly.newPlot('who-thinks-first-bar-chart', JSON.parse(chartsData.who_thinks_first_bar).data, 
                          JSON.parse(chartsData.who_thinks_first_bar).layout, {responsive: true});
        }
        
        // Who thinks first insights
        const whoThinksData = analyticsData.who_thinks_first;
        if (whoThinksData) {
            document.getElementById('who-thinks-first-insights').innerHTML = 
                `<p class="text-gray-700 dark:text-gray-300">${whoThinksData.insights}</p>`;
            
            // Detailed stats
            const statsContainer = document.getElementById('who-thinks-first-stats');
            const stats = whoThinksData.sender_percentages;
            const times = whoThinksData.avg_first_times;
            
            statsContainer.innerHTML = Object.entries(stats || {}).map(([sender, percentage]) => `
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-4">
                    <h5 class="font-semibold text-gray-900 dark:text-white mb-2">${sender}</h5>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div class="text-gray-600 dark:text-gray-300">Days started: <span class="font-medium text-gray-900 dark:text-gray-100">${whoThinksData.sender_first_counts[sender]}</span></div>
                        <div class="text-gray-600 dark:text-gray-300">Percentage: <span class="font-medium text-gray-900 dark:text-gray-100">${percentage}%</span></div>
                        <div class="text-gray-600 dark:text-gray-300">Avg first time: <span class="font-medium text-gray-900 dark:text-gray-100">${times[sender] || 'N/A'}</span></div>
                        <div class="text-gray-600 dark:text-gray-300">Total days: <span class="font-medium text-gray-900 dark:text-gray-100">${whoThinksData.total_days_analyzed}</span></div>
                    </div>
                </div>
            `).join('');
        }
    }
    
    function populateAdvanced() {
        // Affection score gauge
        if (chartsData.affection_score_gauge) {
            Plotly.newPlot('affection-score-gauge', JSON.parse(chartsData.affection_score_gauge).data, 
                          JSON.parse(chartsData.affection_score_gauge).layout, {responsive: true});
        }
        
        // Compatibility meter
        if (chartsData.compatibility_meter) {
            Plotly.newPlot('compatibility-meter', JSON.parse(chartsData.compatibility_meter).data, 
                          JSON.parse(chartsData.compatibility_meter).layout, {responsive: true});
        }
        
        // Mood timeline
        if (chartsData.mood_timeline) {
            Plotly.newPlot('mood-timeline-chart', JSON.parse(chartsData.mood_timeline).data, 
                          JSON.parse(chartsData.mood_timeline).layout, {responsive: true});
        }
        
        // Streaks & gaps timeline
        if (chartsData.streaks_gaps_timeline) {
            Plotly.newPlot('streaks-gaps-timeline-chart', JSON.parse(chartsData.streaks_gaps_timeline).data, 
                          JSON.parse(chartsData.streaks_gaps_timeline).layout, {responsive: true});
        }
        
        // Word cloud
        if (chartsData.wordcloud_data) {
            const wordcloudData = JSON.parse(chartsData.wordcloud_data);
            const wordcloudContainer = document.getElementById('wordcloud-container');
            
            if (wordcloudData.words && wordcloudData.words.length > 0) {
                wordcloudContainer.innerHTML = `
                    <div class="wordcloud-cluster">
                        ${wordcloudData.words.slice(0, 30).map((word, index) => {
                            const count = wordcloudData.counts[index] || 1;
                            const ratio = wordcloudData.max_count ? (count / wordcloudData.max_count) : 0;
                            const size = ratio >= 0.8 ? 5 : ratio >= 0.6 ? 4 : ratio >= 0.4 ? 3 : ratio >= 0.2 ? 2 : 1;
                            const colorClass = 'chip-color-' + ((index % 8) + 1);
                            return `<span class="word-chip chip-size-${size} ${colorClass}">${word}</span>`;
                        }).join('')}
                    </div>
                `;
            } else {
                wordcloudContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No word data available for word cloud</p>';
            }
        }
        
        // Personalized AI report
        const personalizedReport = analyticsData.personalized_ai_report;
        if (personalizedReport) {
            const reportContainer = document.getElementById('personalized-ai-report');
            reportContainer.innerHTML = `
                <div class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-lg p-6 mb-6">
                    <h4 class="text-xl font-semibold text-gray-900 dark:text-white mb-4">${personalizedReport.fun_title}</h4>
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${personalizedReport.summary}</p>
                </div>
                <div class="space-y-4">
                    <h5 class="text-lg font-semibold text-gray-900 dark:text-white">Top 3 Things About Your Bond:</h5>
                    <ul class="space-y-2">
                        ${personalizedReport.top_3_things.map(thing => `
                            <li class="flex items-start">
                                <span class="text-blue-500 dark:text-blue-400 mr-2">‚Ä¢</span>
                                <span class="text-gray-700 dark:text-gray-300">${thing}</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
        }
    }
    
    function showError(message) {
        errorMessage.textContent = message;
        loadingState.classList.add('hidden');
        errorState.classList.remove('hidden');
    }
    
    // Tab switching functionality
    function initializeTabSwitching() {
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function() {
                const tabName = this.dataset.tab;
                
                // Update button states
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active', 'border-blue-500', 'text-blue-600', 'bg-blue-50/50');
                    btn.classList.add('border-transparent', 'text-gray-500');
                });
                
                this.classList.add('active', 'border-blue-500', 'text-blue-600', 'bg-blue-50/50');
                this.classList.remove('border-transparent', 'text-gray-500');
                
                // Update tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                
                const targetTab = document.getElementById(`${tabName}-tab`);
                if (targetTab) {
                    targetTab.classList.remove('hidden');
                }
            });
        });
    }
    
    // Initialize tabs when DOM is loaded
    initializeTabSwitching();
    
      // Export PDF - Windows-compatible direct download
      document.getElementById('export-pdf').addEventListener('click', function() {
          const button = this;
          const originalHTML = button.innerHTML;
          
          // Disable button and show loading state
          button.disabled = true;
          button.innerHTML = '<span class="ml-2 hidden sm:inline">Generating PDF...</span>';
          
          console.log('Starting PDF export for session:', sessionId);
          
          // Show progress messages
          setTimeout(() => {
              if (button.disabled) {
                  button.innerHTML = '<span class="ml-2 hidden sm:inline">Processing data...</span>';
              }
          }, 2000);
          
          setTimeout(() => {
              if (button.disabled) {
                  button.innerHTML = '<span class="ml-2 hidden sm:inline">Creating PDF...</span>';
              }
          }, 5000);
          
          // Direct download approach - most reliable for Windows
          const downloadURL = `/export/${sessionId}?t=${Date.now()}`; // Add timestamp to prevent caching
          
          // Method 1: Try direct window location (forces download)
          const tryDirectDownload = () => {
              window.location.href = downloadURL;
              
              // Success feedback after a delay
              setTimeout(() => {
                  button.innerHTML = '<i data-lucide="download" class="w-4 h-4"></i><span class="ml-2 hidden sm:inline">Downloaded</span>';
                  
                  setTimeout(() => {
                      button.disabled = false;
                      button.innerHTML = originalHTML;
                      if (window.lucide) {
                          lucide.createIcons();
                      }
                  }, 2000);
              }, 1000);
          };
          
          // Method 2: Create downloadable link as backup
          const tryLinkDownload = () => {
              const link = document.createElement('a');
              link.href = downloadURL;
              link.download = `chatlytics_report_${sessionId}.pdf`;
              link.style.display = 'none';
              
              // Add to DOM, click, then remove
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              
              console.log('PDF download link created and clicked');
          };
          
          // First verify the PDF exists, then download
          fetch(downloadURL, { method: 'HEAD' })
              .then(response => {
                  if (response.ok) {
                      console.log('PDF verified, starting download...');
                      
                      // Try both methods for maximum compatibility
                      tryDirectDownload();
                      
                      // Backup method after short delay
                      setTimeout(() => {
                          tryLinkDownload();
                      }, 500);
                      
                  } else {
                      throw new Error(`Server responded with status: ${response.status}`);
                  }
              })
              .catch(error => {
                  console.error('PDF export error:', error);
                  
                  // Error feedback
                  button.innerHTML = '<i data-lucide="alert-circle" class="w-4 h-4"></i><span class="ml-2 hidden sm:inline">Error</span>';
                  
                  setTimeout(() => {
                      button.disabled = false;
                      button.innerHTML = originalHTML;
                      if (window.lucide) {
                          lucide.createIcons();
                      }
                  }, 3000);
                  
                  // Show specific error message
                  alert(`PDF download failed: ${error.message}\n\nPlease try again. If the problem persists, check the browser's download folder or try a different browser.`);
              });
      });
    
    });

    // Help modal functionality
    window.toggleHelp = function() {
        const modal = document.getElementById('help-modal');
        modal.classList.toggle('hidden');
        
        // Re-initialize lucide icons when modal opens
        if (!modal.classList.contains('hidden')) {
            setTimeout(() => {
                lucide.createIcons();
            }, 100);
        }
    }
    
    // Close help modal when clicking outside
    document.getElementById('help-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            toggleHelp();
        }
    });
    
    // Close help modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modal = document.getElementById('help-modal');
            if (!modal.classList.contains('hidden')) {
                toggleHelp();
            }
        }
    });

</script>
{% endblock %}
